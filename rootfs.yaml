{{- $architecture := or .architecture "arm64" -}}
{{- $username := or .username "mobian" -}}
{{- $password := or .password "1234" -}}
{{- $hostname := or .hostname "mobian" -}}
{{- $ssh := or .ssh "" -}}

architecture: {{ $architecture }}

actions:
  - action: debootstrap
    suite: bullseye
    components:
      - main
    mirror: http://deb.debian.org/debian
    variant: minbase

  - action: apt
    recommends: false
    description: Install extrepo
    packages:
      - extrepo

  - action: run
    description: Setup Mobian repository
    chroot: true
    script: scripts/setup-repo.sh

  - action: apt
    recommends: false
    description: Install mobian-specific packages
    packages:
      - mobian-phosh
      - mobian-phosh-games
      # Additional software we don't want metapackages to depend on
      - eog
      - epiphany-browser
      - evince
      - file-roller
      - firefox-esr
      - fractal
      - geary
      - gedit
      - gnome-authenticator
      - gnome-calculator
      - gnome-calendar
      - gnome-contacts
      - gnome-clocks
      - gnome-maps
      - gnome-software
      - gnome-software-plugin-flatpak
      - gnome-sound-recorder
      - gnome-todo
      - gnome-usage
      - gnome-weather
      - kgx
      - lollypop
      - nemo
      - nemo-fileroller
      - telegram-desktop
      - telegram-purple
      - webext-ublock-origin
      - youtube-dl
{{ if $ssh }}
      - openssh-server
{{ end }}
      - cryptsetup
      - cryptsetup-initramfs

  - action: run
    description: Set up default user
    chroot: true
    script: scripts/setup-user.sh {{ $username }} {{ $password }}

{{ if $ssh }}
  - action: overlay
    description: Set up sshd configuration
    source: overlays/sshd_config.d/
    destination: /etc/ssh/sshd_config.d/

  - action: overlay
    description: Set up user's ssh configuration
    source: overlays/ssh/
    destination: /home/{{ $username }}/.ssh/

  - action: run
    description: Set owner of .ssh
    chroot: true
    command: chown -R {{ $username }}:{{ $username }} /home/{{ $username }}/.ssh/
{{ end }}

  - action: run
    description: Set up system
    chroot: true
    script: scripts/setup-system.sh {{ $hostname }}

  - action: pack
    file: rootfs-{{ $architecture }}.tar.gz
